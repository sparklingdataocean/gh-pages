<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Spark for Big Data Analytics.">

    <title>Word2Vec2Graph Page Rank - Sparkling Data Ocean</title>

    <link rel="canonical" href="http://localhost:4000/futurePosts/2017-09-27-word2vec2graphPageRank/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Sparkling Data Ocean" />

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Sparkling Data Ocean</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
				
                <li>
                    <a href="/futurePosts/2017-09-27-word2vec2graphPageRank/">Word2Vec2Graph Page Rank</a>
                </li>
				
                
				
                <li>
                    <a href="/futurePosts/2017-09-29-word2vec2graphPairs/">Word2Vec2Graph for Pairs of Words</a>
                </li>
				
                
				
                <li>
                    <a href="/about/">About</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/sdo11.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Word2Vec2Graph Page Rank</h1>
                    
                    <h2 class="subheading">Connecting Word2vec Model with Graph</h2>
                    
                    <span class="meta">Posted by Melenar on September 26, 2017</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p><h3>Word2Vec2Graph Model</h3>
In the previous post we explained how to build Word2Vec2Graph model as combination of Word2vec model and Graph engine in Spark.
Spark GraphFrames library has many interesting functions. In this post we will look at Page Rank for Word2Vec2Graph.
</p>

<p>We will use the Word2Vec2Graph model based on Word2VecModel model trained on the corpus of combined News data and Wiki data files.</p>

<p><h3>Page Rank</h3>
Read Wiki input file: </p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">wikiPageRank</span> <span class="k">=</span> <span class="n">graphWiki</span><span class="o">.</span><span class="n">pageRank</span><span class="o">.</span><span class="n">resetProbability</span><span class="o">(</span><span class="mf">0.15</span><span class="o">).</span><span class="n">maxIter</span><span class="o">(</span><span class="mi">11</span><span class="o">).</span><span class="n">run</span><span class="o">()</span>
<span class="n">display</span><span class="o">(</span><span class="n">wikiPageRank</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">distinct</span><span class="o">().</span><span class="n">sort</span><span class="o">(</span><span class="n">$</span><span class="s">"pagerank"</span><span class="o">.</span><span class="n">desc</span><span class="o">).</span><span class="n">limit</span><span class="o">(</span><span class="mi">20</span><span class="o">))</span>

<span class="k">val</span> <span class="n">inputWiki</span><span class="k">=</span><span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="s">"/FileStore/tables/opef4cqb1504567762417/WikiTest.txt"</span><span class="o">).</span><span class="n">toDF</span><span class="o">(</span><span class="s">"charLine"</span><span class="o">)</span></code></pre></figure>

<p>Tokenize the file:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.spark.ml._</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.ml.feature._</span>
<span class="n">val</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RegexTokenizer</span><span class="o">().</span>
<span class="n">setInputCol</span><span class="o">(</span><span class="s">"charLine"</span><span class="o">).</span><span class="na">setOutputCol</span><span class="o">(</span><span class="s">"value"</span><span class="o">).</span><span class="na">setPattern</span><span class="o">(</span><span class="s">"[^a-z]+"</span><span class="o">).</span>
<span class="n">setMinTokenLength</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="na">setGaps</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="n">val</span> <span class="n">tokenizedWiki</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">inputWiki</span><span class="o">)</span></code></pre></figure>

<p>Remove stop words: </p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">val</span> <span class="n">remover</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StopWordsRemover</span><span class="o">().</span><span class="na">setInputCol</span><span class="o">(</span><span class="s">"value"</span><span class="o">).</span><span class="na">setOutputCol</span><span class="o">(</span><span class="s">"stopWordFree"</span><span class="o">)</span>
<span class="n">val</span> <span class="n">removedStopWordsWiki</span> <span class="o">=</span> <span class="n">remover</span><span class="o">.</span><span class="na">setStopWords</span><span class="o">(</span><span class="n">Array</span><span class="o">(</span><span class="s">"none"</span><span class="o">,</span><span class="s">"also"</span><span class="o">,</span><span class="s">"nope"</span><span class="o">,</span><span class="s">"null"</span><span class="o">)++</span><span class="n">remover</span><span class="o">.</span><span class="na">getStopWords</span><span class="o">).</span><span class="na">transform</span><span class="o">(</span><span class="n">tokenizedWiki</span><span class="o">)</span></code></pre></figure>

<p><h3>Transform it to Pairs of Words</h3>
Get pairs of words - ngram(2)</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">ngram</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">NGram</span><span class="o">().</span><span class="n">setInputCol</span><span class="o">(</span><span class="s">"stopWordFree"</span><span class="o">).</span><span class="n">setOutputCol</span><span class="o">(</span><span class="s">"ngrams"</span><span class="o">).</span><span class="n">setN</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
<span class="k">val</span> <span class="n">ngramCleanWordsWiki</span> <span class="k">=</span> <span class="n">ngram</span><span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">removedStopWordsWiki</span><span class="o">)</span></code></pre></figure>

<p>Explode ngrams:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.explode</span>
<span class="k">val</span> <span class="n">slpitNgramsWiki</span><span class="k">=</span><span class="n">ngramCleanWordsWiki</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">"ngram"</span><span class="o">,</span><span class="n">explode</span><span class="o">(</span><span class="n">$</span><span class="s">"ngrams"</span><span class="o">)).</span><span class="n">select</span><span class="o">(</span><span class="s">"ngram"</span><span class="o">).</span>
<span class="n">map</span><span class="o">(</span><span class="n">s</span><span class="o">=&gt;(</span><span class="n">s</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">toString</span><span class="o">,</span><span class="n">s</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">toString</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">" "</span><span class="o">)(</span><span class="mi">0</span><span class="o">),</span><span class="n">s</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">toString</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">" "</span><span class="o">)(</span><span class="mi">1</span><span class="o">))).</span><span class="c1">//
</span><span class="n">toDF</span><span class="o">(</span><span class="s">"ngram"</span><span class="o">,</span><span class="s">"ngram1"</span><span class="o">,</span><span class="s">"ngram2"</span><span class="o">).</span><span class="n">filter</span><span class="o">(</span><span class="ss">'ngram1=</span><span class="o">!='</span><span class="n">ngram2</span><span class="o">)</span></code></pre></figure>

<p><h3>Exclude Word Pairs that are not in the Word2Vec Model </h3>

Read the trained Word2VecModel</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.spark.ml.feature.Word2Vec</span>
<span class="k">import</span> <span class="nn">org.apache.spark.ml._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.ml.feature.Word2VecModel</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.Row</span>
<span class="k">val</span> <span class="n">word2vec</span><span class="k">=</span> <span class="k">new</span> <span class="nc">Word2Vec</span><span class="o">()</span>
  <span class="o">.</span><span class="n">setInputCol</span><span class="o">(</span><span class="s">"value"</span><span class="o">)</span>
  <span class="o">.</span><span class="n">setOutputCol</span><span class="o">(</span><span class="s">"result"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">modelNewsWiki</span><span class="k">=</span><span class="nc">Word2VecModel</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">"w2vNewsWiki"</span><span class="o">)</span></code></pre></figure>

<p>Get all words from the Word2Vec model</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">modelWords</span><span class="k">=</span><span class="n">modelNewsWiki</span><span class="o">.</span><span class="n">getVectors</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">"word"</span><span class="o">)</span></code></pre></figure>

<p>Filter out word pairs that are not in words of Word2Vec model</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">ngramW2Vwiki</span><span class="k">=</span><span class="n">slpitNgramsWiki</span><span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">modelWords</span><span class="o">,</span><span class="ss">'ngram1=</span><span class="o">=='</span><span class="n">word</span><span class="o">).</span><span class="n">join</span><span class="o">(</span><span class="n">modelWords</span><span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">"word2"</span><span class="o">),</span><span class="ss">'ngram2=</span><span class="o">=='</span><span class="n">word2</span><span class="o">).</span>
<span class="n">select</span><span class="o">(</span><span class="s">"ngram"</span><span class="o">,</span><span class="s">"ngram1"</span><span class="o">,</span><span class="s">"ngram2"</span><span class="o">).</span><span class="n">distinct</span></code></pre></figure>

<p><h3>Word2Vec Cosine Similarity Function</h3>
Now we want to see how pairs of words are connected. We will create a new function to calculate cosine similarity between words from the Word2Vec model</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.spark.ml.linalg.DenseVector</span>
<span class="k">def</span> <span class="n">dotDouble</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Double</span><span class="o">],</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="o">{</span>
    <span class="o">(</span><span class="k">for</span><span class="o">((</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="n">x</span> <span class="n">zip</span> <span class="n">y</span><span class="o">)</span> <span class="k">yield</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="o">)</span> <span class="n">sum</span>
  <span class="o">}</span>
<span class="k">def</span> <span class="n">magnitudeDouble</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="o">(</span><span class="n">x</span> <span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="n">i</span><span class="o">*</span><span class="n">i</span><span class="o">)</span> <span class="n">sum</span><span class="o">)</span>
  <span class="o">}</span>
<span class="k">def</span> <span class="n">cosineDouble</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Double</span><span class="o">],</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">require</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="o">)</span>
    <span class="n">dotDouble</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)/(</span><span class="n">magnitudeDouble</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="o">*</span> <span class="n">magnitudeDouble</span><span class="o">(</span><span class="n">y</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">modelMap</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">broadcast</span><span class="o">(</span><span class="n">modelNewsWiki</span><span class="o">.</span><span class="n">getVectors</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">r</span><span class="o">=&gt;(</span><span class="n">r</span><span class="o">.</span><span class="n">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span><span class="n">r</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">DenseVector</span><span class="o">](</span><span class="mi">1</span><span class="o">).</span><span class="n">toArray</span><span class="o">)).</span><span class="n">collect</span><span class="o">.</span><span class="n">toMap</span><span class="o">)</span>

<span class="k">def</span> <span class="n">w2wCosine</span><span class="o">(</span><span class="n">word1</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">word2</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">cosineDouble</span><span class="o">(</span><span class="n">modelMap</span><span class="o">.</span><span class="n">value</span><span class="o">(</span><span class="n">word1</span><span class="o">),</span><span class="n">modelMap</span><span class="o">.</span><span class="n">value</span><span class="o">(</span><span class="n">word2</span><span class="o">))</span>
<span class="o">}</span></code></pre></figure>

<p>Example: Word2Vec cosine similarity</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">w2wCosine</span><span class="o">(</span><span class="s">"stress"</span><span class="o">,</span><span class="s">"idea"</span><span class="o">)</span>

<span class="n">res1</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">0.2533538702772619</span></code></pre></figure>

<p><h3>How Word Pairs are Connected?</h3>
Next step: calculate cosine similarity of word pairs:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">ngBroadcastWiki</span><span class="k">=</span><span class="n">sc</span><span class="o">.</span><span class="n">broadcast</span><span class="o">(</span><span class="n">ngramW2Vwiki</span><span class="o">.</span><span class="n">collect</span><span class="o">)</span>
<span class="k">val</span> <span class="n">ngramWord2Vec</span><span class="k">=</span><span class="n">ngBroadcastWiki</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">s</span><span class="o">=&gt;(</span><span class="n">s</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">toString</span><span class="o">,</span><span class="n">s</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">toString</span><span class="o">,</span><span class="n">s</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="n">toString</span><span class="o">,</span>
<span class="n">w2wCosine</span><span class="o">(</span><span class="n">s</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">toString</span><span class="o">,</span><span class="n">s</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="n">toString</span><span class="o">)))</span>
<span class="k">val</span> <span class="n">ngramWord2VecDF</span><span class="k">=</span><span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="n">ngramWord2Vec</span><span class="o">).</span><span class="n">toDF</span><span class="o">(</span><span class="s">"ngram"</span><span class="o">,</span><span class="s">"ngram1"</span><span class="o">,</span><span class="s">"ngram2"</span><span class="o">,</span><span class="s">"cos"</span><span class="o">)</span></code></pre></figure>

<p>Example: Word Pairs with High Cosine Similarity:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">display</span><span class="o">(</span><span class="n">ngramWord2VecDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="ss">'ngram,'cos)</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="ss">'cos&gt;</span><span class="mf">0.8</span><span class="o">))</span>

<span class="n">ngram</span><span class="o">,</span><span class="n">cos</span>
<span class="n">buenos</span> <span class="n">aires</span><span class="o">,</span><span class="mf">0.9164193562252616</span>
<span class="n">johns</span> <span class="n">hopkins</span><span class="o">,</span><span class="mf">0.82613953851904</span>
<span class="n">hundreds</span> <span class="n">thousands</span><span class="o">,</span><span class="mf">0.8022228190557517</span>
<span class="n">psychology</span> <span class="n">harvard</span><span class="o">,</span><span class="mf">0.8081958719357202</span>
<span class="n">psychology</span> <span class="n">sociology</span><span class="o">,</span><span class="mf">0.8133461799616877</span>
<span class="n">soldiers</span> <span class="n">civilians</span><span class="o">,</span><span class="mf">0.8432130270116076</span></code></pre></figure>

<p>Example: Word Pairs with Low Cosine Similarity:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">display</span><span class="o">(</span><span class="n">ngramWord2VecDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="ss">'ngram,'cos)</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="ss">'cos&lt;</span><span class="o">(-</span><span class="mf">0.33</span><span class="o">)))</span>

<span class="n">ngram</span><span class="o">,</span><span class="n">cos</span>
<span class="n">motivation</span> <span class="n">according</span><span class="o">,-</span><span class="mf">0.334148527691187</span>
<span class="n">james</span> <span class="n">defined</span><span class="o">,-</span><span class="mf">0.3599664443972162</span>
<span class="n">spirituality</span> <span class="n">sexual</span><span class="o">,-</span><span class="mf">0.33271384384143715</span>
<span class="n">funding</span> <span class="n">alfred</span><span class="o">,-</span><span class="mf">0.37083478956090055</span>
<span class="n">described</span> <span class="n">sizeable</span><span class="o">,-</span><span class="mf">0.3927395029617375</span>
<span class="n">assignment</span> <span class="n">different</span><span class="o">,-</span><span class="mf">0.34060692231352563</span></code></pre></figure>

<p><h3>Graph on Word Pairs</h3>
Now we can build a graph on word pairs:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.graphframes.GraphFrame</span>

<span class="k">val</span> <span class="n">graphNodes</span><span class="k">=</span><span class="n">ngramWord2VecDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">"ngram1"</span><span class="o">).</span>
  <span class="n">union</span><span class="o">(</span><span class="n">ngramWord2VecDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">"ngram2"</span><span class="o">)).</span><span class="n">distinct</span><span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">graphEdges</span><span class="k">=</span><span class="n">ngramWord2VecDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">"ngram1"</span><span class="o">,</span><span class="s">"ngram2"</span><span class="o">,</span><span class="s">"cos"</span><span class="o">).</span>
  <span class="n">distinct</span><span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">"src"</span><span class="o">,</span><span class="s">"dst"</span><span class="o">,</span><span class="s">"edgeWeight"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">graph</span> <span class="k">=</span> <span class="nc">GraphFrame</span><span class="o">(</span><span class="n">graphNodes</span><span class="o">,</span><span class="n">graphEdges</span><span class="o">)</span></code></pre></figure>

<p>We will Save graph vertices and edges as Parquet to some locations</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">parquet</span><span class="o">(</span><span class="s">"graphWikiNodes"</span><span class="o">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">parquet</span><span class="o">(</span><span class="s">"graphWikiEdges"</span><span class="o">)</span></code></pre></figure>

<p> Load vertices and edges and rebuild the same graph back</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">graphWikiNodes</span> <span class="k">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="o">(</span><span class="s">"graphWikiNodes"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">graphWikiEdges</span> <span class="k">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="o">(</span><span class="s">"graphWikiEdges"</span><span class="o">)</span>

<span class="k">val</span> <span class="n">graphWiki</span> <span class="k">=</span> <span class="nc">GraphFrame</span><span class="o">(</span><span class="n">graphWikiNodes</span><span class="o">,</span> <span class="n">graphWikiEdges</span><span class="o">)</span></code></pre></figure>

<p><h3>Connected Components</h3>
It's a lot of interesting things we can do with Spark GraphFrames. Let's start with connected components.
</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">sc</span><span class="o">.</span><span class="n">setCheckpointDir</span><span class="o">(</span><span class="s">"/FileStore/"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">resultWikiCC</span> <span class="k">=</span> <span class="n">graphWiki</span><span class="o">.</span><span class="n">connectedComponents</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>

<span class="k">val</span> <span class="n">ccWikiCount</span><span class="k">=</span><span class="n">resultWikiCC</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="s">"component"</span><span class="o">).</span><span class="n">count</span><span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">"cc"</span><span class="o">,</span><span class="s">"ccCt"</span><span class="o">)</span>
<span class="n">display</span><span class="o">(</span><span class="n">ccWikiCount</span><span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="ss">'ccCt.</span><span class="n">desc</span><span class="o">))</span></code></pre></figure>

<p>Most of word pairs are in the same large connected component and only a few pairs are separate:
</p>

<p><h3>Connected Components with High Cosine Similarity</h3>
Now we will look at connected components of subgraph with edge weight threshold &gt; 0.6.
</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">edgeHightWeight</span> <span class="k">=</span> <span class="n">graphWiki</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">"edgeWeight &gt; 0.6"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">graphHightWeight</span> <span class="k">=</span> <span class="nc">GraphFrame</span><span class="o">(</span><span class="n">graphWiki</span><span class="o">.</span><span class="n">vertices</span><span class="o">,</span> <span class="n">edgeHightWeight</span><span class="o">)</span></code></pre></figure>

<p>Run connected components for graph with high cosine similarity
</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">graphHightWeightCC</span> <span class="k">=</span> <span class="n">graphHightWeight</span><span class="o">.</span><span class="n">connectedComponents</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>
<span class="k">val</span> <span class="n">graphHightWeightCcCount</span><span class="k">=</span><span class="n">graphHightWeightCC</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="s">"component"</span><span class="o">).</span><span class="n">count</span><span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">"cc"</span><span class="o">,</span><span class="s">"ccCt"</span><span class="o">)</span>
<span class="n">display</span><span class="o">(</span><span class="n">graphHightWeightCcCount</span><span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="ss">'ccCt.</span><span class="n">desc</span><span class="o">).</span><span class="n">limit</span><span class="o">(</span><span class="mi">7</span><span class="o">))</span></code></pre></figure>

<p>Words in the biggest component:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">display</span><span class="o">(</span><span class="n">graphHightWeightCC</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">"component=103079215114"</span><span class="o">))</span>

<span class="n">id</span><span class="o">,</span><span class="n">component</span>
<span class="n">institute</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">harvard</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">cornell</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">psychiatry</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">maryland</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">hopkins</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">yale</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">michigan</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">consultant</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">university</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">johns</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">engineering</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">psychology</span><span class="o">,</span><span class="mi">103079215114</span>
<span class="n">sociology</span><span class="o">,</span><span class="mi">103079215114</span></code></pre></figure>

<p>Words in the second component:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">display</span><span class="o">(</span><span class="n">graphHightWeightCC</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">"component=171798691847"</span><span class="o">))</span>

<span class="n">id</span><span class="o">,</span><span class="n">component</span>
<span class="n">therapy</span><span class="o">,</span><span class="mi">171798691847</span>
<span class="n">functions</span><span class="o">,</span><span class="mi">171798691847</span>
<span class="n">cognitive</span><span class="o">,</span><span class="mi">171798691847</span>
<span class="n">clinical</span><span class="o">,</span><span class="mi">171798691847</span>
<span class="n">behavioral</span><span class="o">,</span><span class="mi">171798691847</span>
<span class="n">practices</span><span class="o">,</span><span class="mi">171798691847</span>
<span class="n">educational</span><span class="o">,</span><span class="mi">171798691847</span>
<span class="n">maps</span><span class="o">,</span><span class="mi">171798691847</span>
<span class="n">genetic</span><span class="o">,</span><span class="mi">171798691847</span></code></pre></figure>

<p><h3>Next Post - Page Rank</h3>
Spark GraphFrames library has many interesting functions. In the next post we will look at Page Rank for Word2Vec2Graph.
</p>


                <hr>

                <ul class="pager">
                    
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a href="mailto:sparkling.dataocean@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Melenar 2017</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


    


</body>

</html>
