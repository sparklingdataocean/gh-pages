<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Spark for Big Data Analytics.">

    <title>CNN Image Classification for Climate Data - Sparkling Data Ocean</title>

    <link rel="canonical" href="http://localhost:4000/2021/04/04/cityTempCNN/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Sparkling Data Ocean" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114694347-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-114694347-1');
    </script>

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Sparkling Data Ocean</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
				
                <li>
                    <a href="/about/">About</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/page1f.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>CNN Image Classification for Climate Data</h1>
                    
                    <h2 class="subheading">How to create CNN image classification model for yearly daily temperature time series data</h2>
                    
                    <span class="meta">Posted by Melenar on April 4, 2021</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p><h3>Convolutional Neural Network Classification Methods</h3>

Outstanding success of Convolutional Neural Network image classification in the last few years influenced application of this technique to extensive variety of objects.


In particular, deep learning techniques became very powerful after evolutionary model AlexNet was created in 2012 to improve the results of ImageNet challenge. Since the introduction of large-scale visual datasets like ImageNet, most success in computer vision has been primarily driven by supervised learning.
</p>
<p>
CNN image classification methods are getting high accuracies but being based on supervised machine learning, they require labeling of huge volumes of data. One of the solution of this challenge is transfer learning. Fine-tuning a network with transfer learning usually works much faster and has higher accuracy than training CNN image classification models from scratch.
</p>
<p>
In this post we examine how to apply CNN image classification transfer learning methods to climate data analysis.

</p>
<p>


<p><h4>CNN Classification of Embedded Vectors</h4>
</p><p>

<p>In this post we will use a deep learning technique that we learned in fast.ai
<i><a href="https://course.fast.ai"> 'Practical Deep Learning for Coders, v3'</a></i>
class and fast.ai forum   
<i><a href="https://forums.fast.ai/t/time-series-sequential-data-study-group/29686">'Time series/ sequential data'</a></i> study group.</p>
<p>
In our previous posts we employed this technique to Natural Language Processing - <i><a href="
http://sparklingdataocean.com/2019/06/01/word2vec2CNN/">"Free Associations -
Find Unexpected Word Pairs via Convolutional Neural Network"</a></i>  and
<i><a href="
http://sparklingdataocean.com/2019/03/16/word2vec2graph2CNN/">"Word2Vec2Graph to Images to Deep Learning."</a></i> and to electroencephalography data analysis: <i><a href="
http://sparklingdataocean.com/2020/08/19/brainGraphEeg/">"EEG Patterns by Deep Learning and Graph Mining."</a></i>


</p><p>
</p>

<p><h4>CNN Classification Method</h4>
<p>For classification method we will convert yearly daily temperature datas to images using Gramian Angular Field (GASF) - a polar coordinate transformation. This method is well described by Ignacio Oguiza in Fast.ai forum
<i><a href="https://forums.fast.ai/t/share-your-work-here/27676/367"> 'Time series classification: General Transfer Learning with Convolutional Neural Networks'</a></i>. He referenced to paper <i><a href="https://aaai.org/ocs/index.php/WS/AAAIW15/paper/viewFile/10179/10251">Encoding Time Series as Images for Visual Inspection and Classification Using Tiled Convolutional Neural Networks</a></i>.

For data processing we will use ideas and code from Ignacio Oguiza code is in his GitHub notebook
<i><a href="https://gist.github.com/oguiza/c9c373aec07b96047d1ba484f23b7b47"> Time series - Olive oil country</a></i>.
<p></p>
<p>
<h3>Data Preprocessing</h3>
<p></p>

<p><h4>Data Source</h4>

To demonstrate how this methods work we will use climate data from kaggle.com data sets:
<i><a href="
https://www.kaggle.com/hansukyang/temperature-history-of-1000-cities-1980-to-2020">"Temperature History of 1000 cities 1980 to 2020"</a></i>.
</p><p>
This data has average daily temperature in Celsius degrees for years from January 1, 1980 to September 30, 2020 for 1000 most populous cities in the world.

</p><p>


<h4>Transform Raw Data to Daily Temperature by Year Vectors</h4>
<p></p>

<p></p>

The raw data of average daily temperature for 1000 cities is represented in 1001 columns - city metadata and average temperature rows for all dates from 1980, January 1 to September 30, 2020.    
<p></p>
<a href="#">
    <img src="/img/scr1a.jpg" alt="Post Sample Image" width="800" />
</a>
<p></p>
<p></p>
To experiment with classification method we'll calculate 'zone' metadata as Tropical, North and South regions based on latitude:
<p></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">cityMetadata</span><span class="p">[</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="p">.</span><span class="nf">to_numeric</span><span class="p">(</span><span class="n">cityMetadata</span><span class="p">[</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">])</span>
<span class="n">cityMetadata</span><span class="p">[</span><span class="sh">'</span><span class="s">lng</span><span class="sh">'</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="p">.</span><span class="nf">to_numeric</span><span class="p">(</span><span class="n">cityMetadata</span><span class="p">[</span><span class="sh">'</span><span class="s">lng</span><span class="sh">'</span><span class="p">])</span>
<span class="n">cityMetadata</span><span class="p">[</span><span class="sh">'</span><span class="s">zone</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">tropic</span><span class="sh">'</span>
<span class="n">cityMetadata</span><span class="p">[</span><span class="sh">'</span><span class="s">zone</span><span class="sh">'</span><span class="p">][</span><span class="n">cityMetadata</span><span class="p">[</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">23.5</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">north</span><span class="sh">'</span>
<span class="n">cityMetadata</span><span class="p">[</span><span class="sh">'</span><span class="s">zone</span><span class="sh">'</span><span class="p">][</span><span class="n">cityMetadata</span><span class="p">[</span><span class="sh">'</span><span class="s">lat</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">23.5</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">south</span><span class="sh">'</span></code></pre></figure>

<p></p>
As city metadata we will use the following columns:
<p></p>
<ul>
<li>City</li>
<li>Country</li>
<li>Latitude</li>
<li>Longitude</li>
<li>Zone</li>
</ul>

<p></p>
We will convert raw data to set of embedded vectors {city, year}:
<p></p>

<ul>
<li>To get the same data format for each time series from raw data we excluded February 29 rows</li>
<li>As we had data only until September 30, 2020, we excluded data for year 2020</li>
<li>From dates formated as 'mm/dd/yyyy' strings we extracted year as 'yyyy' strings</li>

</ul>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">tempCity3</span><span class="o">=</span><span class="n">tempCity2</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">tempCity2</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="sh">"</span><span class="s">2020-</span><span class="sh">"</span><span class="p">))]</span>
<span class="n">tempCity4</span><span class="o">=</span><span class="n">tempCity3</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">tempCity3</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="sh">"</span><span class="s">-02-29</span><span class="sh">"</span><span class="p">))]</span>
<span class="n">tempCity4</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span><span class="o">=</span><span class="n">tempCity4</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">-</span><span class="sh">"</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">tempCity4</span><span class="o">=</span><span class="n">tempCity4</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></figure>

<p></p>
<p></p>

<p></p>



<p></p>
Next, we transformed data to the following structure:

<ul>
<li>Metadata columns: city, latitude, longitude, country, zone, year</li>
<li>365 columns with average daily temperatures</li>
</ul>
<p></p>
<p></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">tempCityGroups</span><span class="o">=</span><span class="n">tempCity5</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">])</span>
<span class="n">dataSet</span><span class="o">=</span><span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1980</span><span class="p">,</span> <span class="mi">2020</span><span class="p">):</span>
  <span class="n">tmpX</span><span class="o">=</span><span class="n">tempCityGroups</span><span class="p">.</span><span class="nf">get_group</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">)).</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">tmpX</span><span class="o">=</span><span class="n">tmpX</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">tmpX</span><span class="p">.</span><span class="n">columns</span><span class="p">[[</span><span class="mi">0</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="n">T</span>
  <span class="n">cityMetadata</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">]</span><span class="o">=</span><span class="n">x</span>  
  <span class="n">cityMetadata</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">tmpX</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">cityMetadata</span><span class="p">,</span> <span class="n">tmpX</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">dataSet</span><span class="o">=</span><span class="n">dataSet</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code></pre></figure>

<p></p>
<p></p>
<a href="#">
    <img src="/img/scr1b.jpg" alt="Post Sample Image" width="800" />
</a>

</p><p>
<h4>Prepare Training Data by Zone</h4>
<p></p>
We will classify daily temperature time series by North, South and Tropical zones. The distribution of populated cities is not proportional by zones:  
about one third of cities are located in Tropical region, much more on Northern region and much less on Southern region:
<ul>
<li>Northern region: 614 cities</li>
<li>Tropical region: 340 cities</li>
<li>Sourthern region: 46 cities</li>
</ul>

<p></p>
To get similar sizes of training data by regions we will take all information for South region (1840 records) and randomly select about 2000 records for North and Tropical regions.
<p></p>

<p></p>
<p><h4>Data Prearation for Southern Region</h4>
<p></p>
We will describe in detail data preparation process for Southern region. For the other two regegions data preparation processes are very similar.
As in raw data we have only 46 cities in Southern region, we will use all this data for training. Here are the following steps:
<ul>
<li>Transforn temperature values from string format to float format </li>
<li>Get a subset of data for Southern region</li>
<li>Split data to metadata and data values</li>
<li>Transform data values to numpy format</li>
<li>Transform daily temperature float arrays to pictures</li>
</ul>
<p></p>
<p></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">dataSet</span> <span class="o">=</span> <span class="n">dataSet</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">dataSet</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:]</span> <span class="o">=</span> <span class="n">dataSet</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">dataSetSouth</span><span class="o">=</span><span class="n">dataSet</span><span class="p">[</span><span class="n">dataSet</span><span class="p">[</span><span class="sh">'</span><span class="s">zone</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">south</span><span class="sh">"</span><span class="p">]</span>
<span class="n">dataSetSouth</span> <span class="o">=</span> <span class="n">dataSetSouth</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">metadataSet</span><span class="o">=</span><span class="n">dataSetSouth</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="mi">7</span><span class="p">]</span>
<span class="n">dataValues</span><span class="o">=</span><span class="n">dataSetSouth</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">dataSetSouth</span><span class="p">.</span><span class="n">columns</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fXcity</span><span class="o">=</span><span class="n">dataValues</span><span class="p">.</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">values</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="kn">from</span> <span class="n">pyts.image</span> <span class="kn">import</span> <span class="n">GramianAngularField</span> <span class="k">as</span> <span class="n">GASF</span>
<span class="n">image_size</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">gasf</span> <span class="o">=</span> <span class="nc">GASF</span><span class="p">(</span><span class="n">image_size</span><span class="p">)</span>
<span class="n">fXcity_gasf</span> <span class="o">=</span> <span class="n">gasf</span><span class="p">.</span><span class="nf">fit_transform</span><span class="p">(</span><span class="n">fXcity</span><span class="p">)</span>
<span class="n">dplt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span></code></pre></figure>

<p></p>
<p></p>

<p></p>
To illustrate examples of images that will be used as training data, we will look at Southern region metadata, select city and year and draw pictures. Here we picked up a row with index=1 from Southern region metadata and draw plot and GASF images for daily weather data in Buenos Aires in 1980:
<p></p>
<a href="#">
    <img src="/img/scr2b.jpg" alt="Post Sample Image" width="500" />
</a>
<p></p>
<p></p>


<p></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">fXcity</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">fXcity_gasf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">rainbow</span><span class="sh">'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="sh">'</span><span class="s">lower</span><span class="sh">'</span><span class="p">)</span></code></pre></figure>

<p></p>
<a href="#">
    <img src="/img/scr2c.jpg" alt="Post Sample Image" width="444" />
</a>
<p></p>
<p></p>

Next, we will transform all {city, year} time series to GASF pictures and store them in 'south' subdirectory. As the name of images we will use combinations of city names and years:


<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">imgPath</span><span class="o">=</span><span class="sh">'</span><span class="s">/content/drive/My Drive/city1</span><span class="sh">'</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">warnings</span>
<span class="n">warnings</span><span class="p">.</span><span class="nf">filterwarnings</span><span class="p">(</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>
<span class="n">IMG_PATH</span> <span class="o">=</span> <span class="n">imgPath</span> <span class="o">+</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="o">+</span> <span class="sh">"</span><span class="s">img10</span><span class="sh">"</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">IMG_PATH</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">IMG_PATH</span><span class="p">)</span>
<span class="n">numRows</span><span class="o">=</span><span class="n">metadataSet</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">numRows</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">IMG_PATH</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">IMG_PATH</span><span class="p">)</span>  
    <span class="n">idxPath</span> <span class="o">=</span> <span class="n">IMG_PATH</span> <span class="o">+</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">metadataSet</span><span class="p">[</span><span class="sh">'</span><span class="s">zone</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">idxPath</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">idxPath</span><span class="p">)</span>
    <span class="n">imgId</span> <span class="o">=</span> <span class="p">(</span><span class="n">IMG_PATH</span> <span class="o">+</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span>  
      <span class="nf">str</span><span class="p">(</span><span class="n">metadataSet</span><span class="p">[</span><span class="sh">'</span><span class="s">zone</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span> <span class="o">+</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span>
      <span class="nf">str</span><span class="p">(</span><span class="n">metadataSet</span><span class="p">[</span><span class="sh">'</span><span class="s">city_ascii</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="sh">'</span><span class="s">~</span><span class="sh">'</span><span class="o">+</span>
      <span class="nf">str</span><span class="p">(</span><span class="n">metadataSet</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">fXcity_gasf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">rainbow</span><span class="sh">'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="sh">'</span><span class="s">lower</span><span class="sh">'</span><span class="p">)</span>   
    <span class="n">plt</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="n">imgId</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>  </code></pre></figure>



<p><h4>Tropical and North Regions</h4>
For Tropical and Northern regions we will shuffle data and select about 2000 rows.

Southern region example: plot and GASF images for daily weather data in Singapore in 1999.
<p></p>
<a href="#">
    <img src="/img/scr2f.jpg" alt="Post Sample Image" width="444" />
</a>
<p></p>
<p></p>

<p></p>
Northern region example: plot and GASF images for daily weather in Moscow in 2013.
<p></p>
<a href="#">
    <img src="/img/scr2g.jpg" alt="Post Sample Image" width="444" />
</a>
<p></p>
<p></p>

<p></p>

<p></p>





<p><h3>Immage Classification</h3>
<p><h4>Training Data Preparation</h4>
For time series classification model we used transfer learning approach from fast.ai library. Here is code to prepare data for model training and and show some Southern region data examples:
<p></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">PATH_IMG</span><span class="o">=</span><span class="n">IMG_PATH</span>
<span class="n">tfms</span> <span class="o">=</span> <span class="nf">get_transforms</span><span class="p">(</span><span class="n">do_flip</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">max_rotate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">seed</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ImageDataBunch</span><span class="p">.</span><span class="nf">from_folder</span><span class="p">(</span><span class="n">PATH_IMG</span><span class="p">,</span>  <span class="n">train</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">valid_pct</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">data</span><span class="p">.</span><span class="nf">show_batch</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span></code></pre></figure>

<p></p>

<p></p>
<a href="#">
    <img src="/img/scr2d.jpg" alt="Post Sample Image" width="333" />
</a>
<p></p>

<h4>Model Training</h4>


<p></p>
Code based on fast.ai library to train the time series classification model and save the results:
<p></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="n">fastai.text</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">fastai.vision</span> <span class="kn">import</span> <span class="n">learner</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">learner</span><span class="p">.</span><span class="nf">cnn_learner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">models</span><span class="p">.</span><span class="n">resnet34</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">error_rate</span><span class="p">)</span>
<span class="n">learn</span><span class="p">.</span><span class="nf">fit_one_cycle</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">learn</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sh">'</span><span class="s">stage-1a</span><span class="sh">'</span><span class="p">)</span></code></pre></figure>



</p><p>
<h4>Interpretation of CNN Classification Model</h4>


<p></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">interp</span> <span class="o">=</span> <span class="n">ClassificationInterpretation</span><span class="p">.</span><span class="nf">from_learner</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
<span class="n">losses</span><span class="p">,</span><span class="n">idxs</span> <span class="o">=</span> <span class="n">interp</span><span class="p">.</span><span class="nf">top_losses</span><span class="p">()</span>
<span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">valid_ds</span><span class="p">)</span><span class="o">==</span><span class="nf">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="o">==</span><span class="nf">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
<span class="n">interp</span><span class="p">.</span><span class="nf">plot_top_losses</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span></code></pre></figure>

<p></p>
<a href="#">
    <img src="/img/scr2s.jpg" alt="Post Sample Image" width="371" />
</a>
<p></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">interp</span><span class="p">.</span><span class="nf">most_confused</span><span class="p">(</span><span class="n">min_val</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="p">[(</span><span class="sh">'</span><span class="s">tropic</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">north</span><span class="sh">'</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
 <span class="p">(</span><span class="sh">'</span><span class="s">tropic</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">south</span><span class="sh">'</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
 <span class="p">(</span><span class="sh">'</span><span class="s">south</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">north</span><span class="sh">'</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
 <span class="p">(</span><span class="sh">'</span><span class="s">north</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">tropic</span><span class="sh">'</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
 <span class="p">(</span><span class="sh">'</span><span class="s">south</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">tropic</span><span class="sh">'</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
 <span class="p">(</span><span class="sh">'</span><span class="s">north</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">south</span><span class="sh">'</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]</span>  

<span class="n">interp</span><span class="p">.</span><span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span></code></pre></figure>

<p></p>
<a href="#">
    <img src="/img/scr2r.jpg" alt="Post Sample Image" width="314" />
</a>
<p></p>

</p><p>
<h4>CNN Model Accuracy Statistics</h4>


<p></p>
<p></p>
The error rate of the model is 6.8% and the arccuracy about 93.8%.
<p></p>
To calculate accuracy statistics we'll read the data and run it through the model and split the results by zone:
<p></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">path7</span><span class="o">=</span><span class="sh">'</span><span class="s">/content/drive/MyDrive/city1/img10/</span><span class="sh">'</span>
<span class="n">dirs7</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span> <span class="n">path7</span> <span class="p">)</span>
<span class="n">cityList</span><span class="o">=</span><span class="p">[]</span>
<span class="n">res7</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">north</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">south</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">tropic</span><span class="sh">'</span><span class="p">]:</span>
  <span class="n">dirZone</span><span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span> <span class="n">path7</span> <span class="o">+</span> <span class="n">zone</span><span class="p">)</span>
  <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">dirZone</span><span class="p">:</span>
    <span class="n">cityList</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">path7</span> <span class="o">+</span> <span class="n">zone</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span><span class="nb">file</span><span class="p">)</span>
    <span class="n">pred_class</span><span class="p">,</span><span class="n">pred_idx</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">learn</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="nf">open_image</span><span class="p">(</span><span class="n">path7</span> <span class="o">+</span> <span class="n">zone</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span> <span class="o">+</span><span class="nb">file</span><span class="p">))</span>
    <span class="n">res7</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">zone</span><span class="p">,</span><span class="nb">file</span><span class="p">,</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">tolist</span><span class="p">(),</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">tolist</span><span class="p">(),</span><span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">tolist</span><span class="p">()))</span>
<span class="n">dfResZone</span> <span class="o">=</span> <span class="nc">DataFrame </span><span class="p">(</span><span class="n">res7</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">zone</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">predNorth</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">predSouth</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">predTropic</span><span class="sh">'</span><span class="p">])</span>
<span class="n">cityYearProbTropic</span><span class="o">=</span><span class="n">cityYearProb</span><span class="p">[</span><span class="n">cityYearProb</span><span class="p">[</span><span class="sh">'</span><span class="s">zone</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="sh">'</span><span class="s">tropic</span><span class="sh">'</span><span class="p">]</span>
<span class="n">cityYearProbSouth</span><span class="o">=</span><span class="n">cityYearProb</span><span class="p">[</span><span class="n">cityYearProb</span><span class="p">[</span><span class="sh">'</span><span class="s">zone</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="sh">'</span><span class="s">south</span><span class="sh">'</span><span class="p">]</span>
<span class="n">cityYearProbNorth</span><span class="o">=</span><span class="n">cityYearProb</span><span class="p">[</span><span class="n">cityYearProb</span><span class="p">[</span><span class="sh">'</span><span class="s">zone</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="sh">'</span><span class="s">north</span><span class="sh">'</span><span class="p">]</span></code></pre></figure>

<p></p>
<p></p>


<p></p>
For each table we calculated statistics:

<p></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">cityYearProbTropic</span><span class="p">.</span><span class="nf">describe</span><span class="p">()</span>
        <span class="n">predNorth</span>	<span class="n">predSouth</span>	<span class="n">predTropic</span>	<span class="n">lat</span>	        <span class="n">lng</span>
<span class="n">count</span>	<span class="mf">2017.000000</span>	<span class="mf">2017.000000</span>	<span class="mf">2017.000000</span>	<span class="mf">2017.000000</span>	<span class="mf">2017.000000</span>
<span class="n">mean</span>	<span class="mf">0.069153</span>	<span class="mf">0.024727</span>	<span class="mf">0.906120</span>	<span class="mf">6.760149</span>	<span class="mf">28.098896</span>
<span class="n">std</span>	<span class="mf">0.168732</span>	<span class="mf">0.116081</span>	<span class="mf">0.203176</span>	<span class="mf">12.707139</span>	<span class="mf">77.334275</span>
<span class="nb">min</span>	<span class="mf">0.000014</span>	<span class="mf">0.000008</span>	<span class="mf">0.000018</span>	<span class="o">-</span><span class="mf">23.490000</span>	<span class="o">-</span><span class="mf">175.220600</span>
<span class="mi">25</span><span class="o">%</span>	<span class="mf">0.000592</span>	<span class="mf">0.000175</span>	<span class="mf">0.941811</span>	<span class="o">-</span><span class="mf">2.980000</span>	<span class="o">-</span><span class="mf">45.879900</span>
<span class="mi">50</span><span class="o">%</span>	<span class="mf">0.003178</span>	<span class="mf">0.000662</span>	<span class="mf">0.993542</span>	<span class="mf">9.935000</span>	<span class="mf">37.340000</span>
<span class="mi">75</span><span class="o">%</span>	<span class="mf">0.029660</span>	<span class="mf">0.003441</span>	<span class="mf">0.998776</span>	<span class="mf">17.400000</span>	<span class="mf">100.329400</span>
<span class="nb">max</span>	<span class="mf">0.993994</span>	<span class="mf">0.999964</span>	<span class="mf">0.999953</span>	<span class="mf">23.489500</span>	<span class="mf">179.216600</span></code></pre></figure>



</p><p>
Then we combined resuls by taking north region probability ('predNorth' column) for Northern region statistics, tropic region probability for Tropical region statistics and south region probability for Southern region.
<p></p>
<a href="#">
    <img src="/img/scr2n.jpg" alt="Post Sample Image" width="444" />
</a>
<p></p>
<p></p>
Here are max, min and mean image examples for Northern, Southern and Tropical regions:
<p></p>
<a href="#">
    <img src="/img/scr2p.jpg" alt="Post Sample Image" width="400" />
</a>
<p></p>
<p></p>

<p><h3>Next Post - Unsupervised Learning</h3>
In the next post we will show how to build unsupervised learning CNN image classification model.</p>
<p></p>

<p></p>
</p></p></p></p></p></p></p></p></p></p>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2020/08/19/brainGraphEeg/" data-toggle="tooltip" data-placement="top" title="EEG Patterns by Deep Learning and Graph Mining">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2021/08/01/unsupervisdCityTempCNN/" data-toggle="tooltip" data-placement="top" title="Unsupervised Deep Learning for Climate Data Analysis">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a href="mailto:sparkling.dataocean@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Melenar 2024</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-114694347-1', 'auto');
  ga('send', 'pageview');

</script>



</body>

</html>
