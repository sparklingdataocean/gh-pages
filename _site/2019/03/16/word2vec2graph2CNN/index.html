<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Spark for Big Data Analytics.">

    <title>Word2Vec2Graph to Images to Deep Learning - Sparkling Data Ocean</title>

    <link rel="canonical" href="http://localhost:4000/2019/03/16/word2vec2graph2CNN/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Sparkling Data Ocean" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114694347-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-114694347-1');
    </script>

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Sparkling Data Ocean</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
				
                <li>
                    <a href="/about/">About</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/modern123.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Word2Vec2Graph to Images to Deep Learning</h1>
                    
                    <h2 class="subheading">Validate Text Topics via Convolutional Neural Network</h2>
                    
                    <span class="meta">Posted by Melenar on March 16, 2019</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<p><h3>Vector Classification</h3>
<p>In this post we will play with another amazing deep learning technique about Time Series classification via CNN Deep Learning. We learned this technique in fast.ai
<i><a href="https://course.fast.ai"> 'Practical Deep Learning for Coders, v3'</a></i>
class and fast.ai forum   
<i><a href="https://forums.fast.ai/t/time-series-sequential-data-study-group/29686">'Time series/ sequential data'</a></i> study group.</p>

<p>We will analyze a long document, uncover new topics (clusters) and use CNN classification as a validation method for graph clustering.   
</p>

<p>
To find topics in long text file we will build Word2Vec2Graph on top of Word2Vec model. Document words will be used as graph nodes and cosine similarities between word vectors as edge weights for this graph. The Word2Vec2Graph model is described in details in previous posts of this blog.
</p>
<p>
Word vectors will be transformed to images using method described in notebook created by Ignacio Oguiza
<i><a href="https://gist.github.com/oguiza/c9c373aec07b96047d1ba484f23b7b47"> Time series - Olive oil country</a></i>. As different clusters we will use topics generated from Word2Vec2Graph graph. Than we will use  CNN classification model to validate clustering:
</p><p>
</p>



<a href="#">
    <img src="/img/picture7c.jpg" alt="Post Sample Image" width="800" height="500" />
</a>

<p>

</p>

<p>
In particular, we will use CNN classification model to prove that topic we discover are different. This validation method will not let us to get rid of noise in our clusters: if two words are in the same cluster it does not mean that they are highly connected. But if two words are in different clusters they obviously do not belong to the same topic.



<h3>Data Preparation</h3>
<p>
Data preparation process for Word2Vec2Graph model in described in previous posts and summarized in the  <i><a href="http://sparklingdataocean.com/2018/04/04/word2vec2graphInsights/

">"Word2Vec2Graph - Insights"</a></i> post. Here we used the same data preparation process of text data about Creativity and Aha Moments:Word2Vec2Graph - Insights
</p>
<ul>
<li>Read text file</li>
<li>Tokenize</li>
<li>Remove stop words</li>
<li>Read trained Word2Vec model</li>
<li>Build a graph with words as nodes and cosine similarities as edge weights.</li>
<li>Save graph vertices and edges</li>
</ul>
<p></p>

<h3>Read and Clean File about Creativity and Aha Moments </h3>
<p></p>
Read text file, tokenize it and remove stop words:
<p></p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.spark.ml._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.ml.feature._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.explode</span>
<span class="k">import</span> <span class="nn">org.apache.spark.ml.feature.Word2Vec</span>
<span class="k">import</span> <span class="nn">org.apache.spark.ml.feature.Word2VecModel</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.Row</span>
<span class="k">import</span> <span class="nn">org.apache.spark.ml.linalg.Vector</span>
<span class="k">import</span> <span class="nn">org.graphframes.GraphFrame</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.DataFrame</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.expressions.Window</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.explode</span>
<span class="k">val</span> <span class="n">tokenizer</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">RegexTokenizer</span><span class="o">().</span>
   <span class="n">setInputCol</span><span class="o">(</span><span class="s">"charLine"</span><span class="o">).</span>
   <span class="n">setOutputCol</span><span class="o">(</span><span class="s">"value"</span><span class="o">).</span>
   <span class="n">setPattern</span><span class="o">(</span><span class="s">"[^a-z]+"</span><span class="o">).</span>
   <span class="n">setMinTokenLength</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span>
   <span class="n">setGaps</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="k">val</span> <span class="n">inputInsight</span><span class="k">=</span><span class="n">sc</span><span class="o">.</span>
   <span class="n">textFile</span><span class="o">(</span><span class="s">"/FileStore/tables/ahaMoments.txt"</span><span class="o">).</span>
   <span class="n">toDF</span><span class="o">(</span><span class="s">"charLine"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">tokenizedInsight</span> <span class="k">=</span> <span class="n">tokenizer</span><span class="o">.</span>
   <span class="n">transform</span><span class="o">(</span><span class="n">inputInsight</span><span class="o">)</span>
<span class="k">val</span> <span class="n">remover</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StopWordsRemover</span><span class="o">().</span>
   <span class="n">setInputCol</span><span class="o">(</span><span class="s">"value"</span><span class="o">).</span>
   <span class="n">setOutputCol</span><span class="o">(</span><span class="s">"stopWordFree"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">removedStopWordsInsight</span> <span class="k">=</span> <span class="n">remover</span><span class="o">.</span>
   <span class="n">setStopWords</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="s">"none"</span><span class="o">,</span><span class="s">"also"</span><span class="o">,</span><span class="s">"nope"</span><span class="o">,</span><span class="s">"null"</span><span class="o">)++</span>
   <span class="n">remover</span><span class="o">.</span><span class="n">getStopWords</span><span class="o">).</span>
   <span class="n">transform</span><span class="o">(</span><span class="n">tokenizedInsight</span><span class="o">)</span>
<span class="k">val</span> <span class="n">slpitCleanInsight</span> <span class="k">=</span> <span class="n">removedStopWordsInsight</span><span class="o">.</span>
   <span class="n">withColumn</span><span class="o">(</span><span class="s">"cleanWord"</span><span class="o">,</span><span class="n">explode</span><span class="o">(</span><span class="n">$</span><span class="s">"stopWordFree"</span><span class="o">)).</span>
   <span class="n">select</span><span class="o">(</span><span class="s">"cleanWord"</span><span class="o">).</span>
   <span class="n">distinct</span></code></pre></figure>


<p></p>
Read trained Word2Vec model and from data about Creativity and Aha Moments text exclude words that are not in the model:
<p></p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">word2vec</span><span class="k">=</span> <span class="k">new</span> <span class="nc">Word2Vec</span><span class="o">().</span>
   <span class="n">setInputCol</span><span class="o">(</span><span class="s">"value"</span><span class="o">).</span>
   <span class="n">setOutputCol</span><span class="o">(</span><span class="s">"result"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">modelNewsBrain</span><span class="k">=</span><span class="nc">Word2VecModel</span><span class="o">.</span>
   <span class="n">read</span><span class="o">.</span>
   <span class="n">load</span><span class="o">(</span><span class="s">"w2VmodelNewsBrain"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">modelWordsInsight</span><span class="k">=</span><span class="n">modelNewsBrain</span><span class="o">.</span>
   <span class="n">getVectors</span><span class="o">.</span>
   <span class="n">select</span><span class="o">(</span><span class="s">"word"</span><span class="o">,</span><span class="s">"vector"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">cleanInsight</span><span class="k">=</span><span class="n">slpitCleanInsight</span><span class="o">.</span>
   <span class="n">join</span><span class="o">(</span><span class="n">modelWordsInsight</span><span class="o">,</span><span class="ss">'cleanWord=</span><span class="o">=='</span><span class="n">word</span><span class="o">).</span>
   <span class="n">select</span><span class="o">(</span><span class="s">"word"</span><span class="o">,</span><span class="s">"vector"</span><span class="o">).</span>
   <span class="n">distinct</span></code></pre></figure>


<h3>Build a Graph and Find Topics</h3>
<p>
Read nodes and edges that we calculated and saved before, build a graph with words as nodes and cosine similarities as edge weights. How to build the graph was described in details in our post <i><a href="
http://sparklingdataocean.com/2017/09/17/word2vec2graph/">"Introduction to Word2Vec2Graph Model."</a></i>
</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">graphInsightVertices</span> <span class="k">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="o">(</span><span class="s">"graphVerticesSub"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">graphInsightEdges</span> <span class="k">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="o">(</span><span class="s">"graphEdgesSub"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">graphInsight2</span> <span class="k">=</span> <span class="nc">GraphFrame</span><span class="o">(</span><span class="n">graphInsightVertices</span><span class="o">,</span> <span class="n">graphInsightEdges</span><span class="o">)</span>
<span class="n">graphInsight2</span><span class="o">.</span><span class="n">persist</span></code></pre></figure>

<p></p>
Function to calculate connected components with cosine similarly and component size parameters:
<p></p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">word2vector2ghraphCCid</span><span class="o">(</span><span class="n">graphVertices</span><span class="k">:</span> <span class="kt">DataFrame</span><span class="o">,</span> <span class="n">graphEdges</span><span class="k">:</span> <span class="kt">DataFrame</span><span class="o">,</span>
     <span class="n">cosineMin</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">cosineMax</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span><span class="k">:</span>
  <span class="kt">DataFrame</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">graphEdgesSub</span><span class="k">=</span> <span class="n">graphEdges</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="ss">'edgeWeight&gt;</span><span class="n">cosineMin</span><span class="o">).</span><span class="n">filter</span><span class="o">(</span><span class="ss">'edgeWeight&lt;</span><span class="n">cosineMax</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">graphSub</span> <span class="k">=</span> <span class="nc">GraphFrame</span><span class="o">(</span><span class="n">graphVertices</span><span class="o">,</span> <span class="n">graphEdgesSub</span><span class="o">)</span>
  <span class="n">sc</span><span class="o">.</span><span class="n">setCheckpointDir</span><span class="o">(</span><span class="s">"/FileStore/"</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">resultCC</span> <span class="k">=</span> <span class="n">graphSub</span><span class="o">.</span>
     <span class="n">connectedComponents</span><span class="o">.</span>
     <span class="n">run</span><span class="o">()</span>
  <span class="k">val</span> <span class="n">resultCCcount</span><span class="k">=</span><span class="n">resultCC</span><span class="o">.</span>
     <span class="n">groupBy</span><span class="o">(</span><span class="s">"component"</span><span class="o">).</span>
     <span class="n">count</span><span class="o">.</span>
     <span class="n">toDF</span><span class="o">(</span><span class="s">"cc"</span><span class="o">,</span><span class="s">"ccCt"</span><span class="o">)</span>
  <span class="n">resultCC</span><span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">resultCCcount</span><span class="o">,</span><span class="ss">'component=</span><span class="o">=='</span><span class="n">cc</span><span class="o">).</span>    
     <span class="n">select</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span><span class="s">"component"</span><span class="o">,</span><span class="s">"ccCt"</span><span class="o">).</span><span class="n">distinct</span>
<span class="o">}</span></code></pre></figure>

<p></p>
Calculate connected components with high cosine similarly:
<p></p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">resultsCCid</span><span class="k">=</span><span class="n">word2vector2ghraphCCid</span><span class="o">(</span><span class="n">graphInsightVertices</span><span class="o">,</span> <span class="n">graphInsightEdges</span><span class="o">,</span><span class="mf">0.8</span><span class="o">,</span> <span class="mf">0.99</span><span class="o">)</span>

<span class="n">display</span><span class="o">(</span><span class="n">resultsCCid</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">"component"</span><span class="o">,</span><span class="s">"ccCt"</span><span class="o">).</span><span class="n">distinct</span><span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="ss">'ccCt.</span><span class="n">desc</span><span class="o">))</span>
   <span class="n">component</span>	<span class="n">ccCt</span>
  <span class="mi">8589934606</span>	 <span class="mi">315</span>
          <span class="mi">19</span>	  <span class="mi">80</span>
           <span class="mi">2</span>	  <span class="mi">70</span>
 <span class="mi">60129542151</span>	  <span class="mi">52</span>
 <span class="mi">17179869190</span>	  <span class="mi">44</span>
 <span class="mi">25769803789</span>	  <span class="mi">12</span>
 <span class="mi">34359738374</span>	   <span class="mi">8</span>
<span class="mi">180388626448</span>	   <span class="mi">7</span>
<span class="mi">455266533384</span>	   <span class="mi">7</span></code></pre></figure>


<h3>Calculate Top PageRanks for Connected Components</h3>
<p>Calculate graph Page Ranks:</p>


<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">graphSub2PageRank</span> <span class="k">=</span> <span class="n">graphInsight2</span><span class="o">.</span>
   <span class="n">pageRank</span><span class="o">.</span>
   <span class="n">resetProbability</span><span class="o">(</span><span class="mf">0.15</span><span class="o">).</span>
   <span class="n">maxIter</span><span class="o">(</span><span class="mi">11</span><span class="o">).</span>
   <span class="n">run</span><span class="o">()</span>
<span class="n">display</span><span class="o">(</span><span class="n">graphSub2PageRank</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span>
   <span class="n">distinct</span><span class="o">.</span>
   <span class="n">sort</span><span class="o">(</span><span class="n">$</span><span class="s">"pagerank"</span><span class="o">.</span><span class="n">desc</span><span class="o">))</span>

<span class="n">id</span>     <span class="n">pagerank</span>
<span class="n">funny</span>    <span class="mf">4.66</span>
<span class="n">costumes</span>    <span class="mf">3.92</span>
<span class="n">weird</span>    <span class="mf">3.82</span>
<span class="n">brandon</span>     <span class="mf">3.60</span>
<span class="n">integrated</span>    <span class="mf">3.52</span>
<span class="n">symptoms</span>    <span class="mf">3.37</span>
<span class="n">decrease</span>    <span class="mf">3.35</span>
<span class="n">craig</span>     <span class="mf">3.27</span>
<span class="n">bruce</span>    <span class="mf">3.19</span></code></pre></figure>


<p>
Join PageRank data with connected components and find the top Page Rank word for each component:
</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">graphCCpageRank</span><span class="k">=</span><span class="n">graphSub2PageRank</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span>
   <span class="n">join</span><span class="o">(</span><span class="n">resultsCCid</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">"ccCt&gt;12"</span><span class="o">)</span> <span class="o">,</span><span class="nc">Seq</span><span class="o">(</span><span class="s">"id"</span><span class="o">))</span>

<span class="k">val</span> <span class="n">partitionWindow</span> <span class="k">=</span> <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class="n">$</span><span class="s">"component"</span><span class="o">).</span>
   <span class="n">orderBy</span><span class="o">(</span><span class="n">$</span><span class="s">"pageRank"</span><span class="o">.</span><span class="n">desc</span><span class="o">)</span>
<span class="k">val</span> <span class="n">ccTopPageRank</span> <span class="k">=</span> <span class="n">graphCCpageRank</span><span class="o">.</span>
   <span class="n">withColumn</span><span class="o">(</span><span class="s">"ccPageRank"</span><span class="o">,</span> <span class="n">rank</span><span class="o">().</span><span class="n">over</span><span class="o">(</span><span class="n">partitionWindow</span><span class="o">)).</span>
   <span class="n">select</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span><span class="s">"component"</span><span class="o">).</span><span class="n">toDF</span><span class="o">(</span><span class="s">"topCCword"</span><span class="o">,</span><span class="s">"componentId"</span><span class="o">)</span>

<span class="n">display</span><span class="o">(</span><span class="n">ccTopPageRank</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">"ccPageRank=1"</span><span class="o">))</span>
   <span class="n">topCCword</span>	<span class="n">componentId</span>
   <span class="n">decrease</span>	<span class="mi">19</span>
   <span class="n">emory</span>	<span class="mi">17179869190</span>
   <span class="n">integrated</span>	<span class="mi">2</span>
   <span class="n">funny</span>	<span class="mi">8589934606</span>
   <span class="n">symptoms</span>	<span class="mi">60129542151</span></code></pre></figure>


<p>
Use the top PageRank as a class word for connected components:
</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">classWords</span><span class="k">=</span><span class="n">resultsCCid</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">"ccCt&gt;12"</span><span class="o">).</span>
   <span class="n">join</span><span class="o">(</span><span class="n">ccTopPageRank</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">"ccPageRank=1"</span><span class="o">),</span><span class="ss">'component=</span><span class="o">=='</span><span class="n">componentId</span><span class="o">).</span>
   <span class="n">withColumn</span><span class="o">(</span><span class="s">"classWord"</span><span class="o">,</span><span class="n">concat</span><span class="o">(</span><span class="n">$</span><span class="s">"topCCword"</span><span class="o">,</span><span class="n">lit</span><span class="o">(</span><span class="s">"~"</span><span class="o">),</span><span class="n">$</span><span class="s">"ccCt"</span><span class="o">)).</span>
   <span class="n">select</span><span class="o">(</span><span class="s">"classWord"</span><span class="o">,</span><span class="s">"id"</span><span class="o">)</span></code></pre></figure>


<p>
Define word vectors, convert vectors to strings and save it as csv file:
</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">cc2vec</span><span class="k">=</span><span class="n">classWords</span><span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">modelWordsInsight</span><span class="o">,</span><span class="ss">'id=</span><span class="o">=='</span><span class="n">word</span><span class="o">).</span><span class="n">drop</span><span class="o">(</span><span class="s">"word"</span><span class="o">).</span>
   <span class="n">map</span><span class="o">(</span><span class="n">s</span><span class="o">=&gt;(</span><span class="n">s</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">toString</span><span class="o">,</span><span class="n">s</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">toString</span><span class="o">,</span><span class="n">s</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="n">toString</span><span class="o">)).</span>
   <span class="n">toDF</span><span class="o">(</span><span class="s">"class"</span><span class="o">,</span><span class="s">"classWord"</span><span class="o">,</span><span class="s">"vec"</span><span class="o">).</span>
   <span class="n">withColumn</span><span class="o">(</span><span class="s">"vec2"</span><span class="o">,</span><span class="n">regexp_replace</span><span class="o">(</span><span class="n">$</span><span class="s">"vec"</span><span class="o">,</span><span class="s">"\\["</span><span class="o">,</span><span class="s">" "</span><span class="o">)).</span><span class="n">drop</span><span class="o">(</span><span class="s">"vec"</span><span class="o">).</span>
   <span class="n">withColumn</span><span class="o">(</span><span class="s">"vecString"</span><span class="o">,</span><span class="n">regexp_replace</span><span class="o">(</span><span class="n">$</span><span class="s">"vec2"</span><span class="o">,</span><span class="s">"\\]"</span><span class="o">,</span><span class="s">" "</span><span class="o">)).</span><span class="n">drop</span><span class="o">(</span><span class="s">"vec2"</span><span class="o">)</span>

<span class="n">class</span><span class="o">,</span><span class="n">classWord</span><span class="o">,</span><span class="n">vecString</span>
<span class="n">integrated</span><span class="o">~</span><span class="mi">70</span><span class="o">,</span><span class="n">solutions</span><span class="o">,</span><span class="s">" -0.14655259251594543,-0.0015149622922763228,-0.21045255661010742,0.02907191775739193,-0.010674788616597652,0.08036941289901733,
   0.010507240891456604,-0.17006824910640717,0.11951962113380432,-0.14497050642967224,-0.0026977339293807745,0.04952468350529671,0.2884736657142639,-0.05758485198020935,-0.1312779188156128,0.024382397532463074,0.008873523212969303,0.1334419697523117,-0.031296879053115845,0.015222832560539246,-0.05807945132255554,0.09823902696371078,-0.15477193892002106,0.17183831334114075,0.25637099146842957,0.16214020550251007,-0.04585354030132294,0.08420883864164352,0.031161364167928696,0.11333728581666946,-0.1724082976579666,0.014776589348912239,0.26824718713760376,-0.06685803830623627,-0.05233914777636528,0.017242418602108955,0.1938367635011673,0.013044198974967003,
   0.047730378806591034,0.16761474311351776,-0.07305202633142471,0.11029835790395737,... "</span></code></pre></figure>



<p><h3>Using CNN Deep Learning for Topic Validation </h3>
<p>
To convert vectors to images and classify images via CNN we used almost the same code that Ignacio Oguiza shared on fast.ai forum
<i><a href="https://gist.github.com/oguiza/c9c373aec07b96047d1ba484f23b7b47"> Time series - Olive oil country</a></i>.
</p><p>
We splitted the source file to words={class, classWord} and vecString. The 'class' column was used to define a topic category for images and 'classWord' column to define image name. The 'vecString' column was splitted by comma to numbers.
</p>


<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">imgFile</span> <span class="k">=</span> <span class="nc">PATH</span> <span class="o">+</span> <span class="err">‘</span><span class="n">wordVec</span><span class="o">.</span><span class="n">csv</span><span class="o">'</span>
<span class="n">words</span> <span class="k">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="o">(</span><span class="n">imgFile</span><span class="o">,</span> <span class="n">sep</span><span class="o">=',',</span><span class="n">usecols</span><span class="o">=[</span><span class="err">0</span>,<span class="err">1</span><span class="o">])</span>
<span class="n">vectors</span> <span class="k">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="o">(</span><span class="n">imgFile</span><span class="o">,</span> <span class="n">sep</span><span class="o">=',').</span><span class="n">drop</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="n">columns</span><span class="o">[</span><span class="err">0</span><span class="o">],</span> <span class="n">axis</span><span class="k">=</span><span class="mi">1</span><span class="o">).</span><span class="n">drop</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="n">columns</span><span class="o">[</span><span class="err">1</span><span class="o">],</span> <span class="n">axis</span><span class="k">=</span><span class="mi">1</span><span class="o">)</span>
<span class="n">numbers</span> <span class="k">=</span> <span class="n">vectors</span><span class="o">[</span><span class="kt">'vecString'</span><span class="o">].</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="sc">','</span><span class="o">,</span> <span class="n">expand</span><span class="k">=</span> <span class="nc">True</span> <span class="o">)</span>
<span class="n">imgId</span> <span class="k">=</span> <span class="nc">PATH</span> <span class="o">+</span> <span class="n">str</span><span class="o">(</span><span class="n">f</span><span class="o">[</span><span class="kt">'class'</span><span class="o">][</span><span class="kt">i</span><span class="o">])</span> <span class="o">+</span> <span class="sc">'/'</span><span class="o">+</span><span class="n">str</span><span class="o">(</span><span class="n">f</span><span class="o">[</span><span class="kt">'classWord'</span><span class="o">][</span><span class="kt">i</span><span class="o">])</span> <span class="o">+</span> <span class="o">'.</span><span class="n">jpg</span><span class="o">'</span></code></pre></figure>


<p>
We tuned the classification model and we've got about 91% accuracy.
Potentially this accuracy can be improved using more advanced Word2Vec model.


</p>
<h3>Graphs of Topics</h3>
<p>
Function to find two degree neighbors ('friend of a friend') by word and transform the results to DOT language:
</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">foaf2dot</span><span class="o">(</span><span class="n">graph</span><span class="k">:</span> <span class="kt">GraphFrame</span><span class="o">,</span> <span class="n">node</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>  
   <span class="n">graph</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="s">"(a) - [ab] -&gt; (b); (b) - [bc] -&gt; (c)"</span><span class="o">).</span>
   <span class="n">filter</span><span class="o">(</span><span class="n">$</span><span class="s">"a.id"</span><span class="o">=!=</span><span class="n">$</span><span class="s">"c.id"</span><span class="o">).</span>
   <span class="n">filter</span><span class="o">(</span><span class="n">$</span><span class="s">"a.id"</span><span class="o">===</span><span class="n">node</span><span class="o">).</span>
   <span class="n">select</span><span class="o">(</span><span class="s">"ab.src"</span><span class="o">,</span><span class="s">"ab.dst"</span><span class="o">,</span><span class="s">"bc.dst"</span><span class="o">).</span><span class="n">toDF</span><span class="o">(</span><span class="s">"word1"</span><span class="o">,</span><span class="s">"worrd2"</span><span class="o">,</span><span class="s">"word3"</span><span class="o">).</span>
   <span class="n">map</span><span class="o">(</span><span class="n">s</span><span class="o">=&gt;(</span><span class="n">s</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">toString</span> <span class="o">+</span> <span class="s">" -&gt; "</span><span class="o">+</span> <span class="n">s</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">toString</span> <span class="o">+</span> <span class="s">"; "</span> <span class="o">+</span> <span class="n">s</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">toString</span> <span class="o">+</span> <span class="s">" -&gt; "</span><span class="o">+</span> <span class="n">s</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="n">toString</span><span class="o">))</span>
<span class="o">}</span>  </code></pre></figure>


<p>
Calculate two degree neighbors for top PageRank words of connected components.
</p>


<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">display</span><span class="o">(</span><span class="n">foaf2dot</span><span class="o">(</span><span class="n">graphInsight2</span><span class="o">,</span><span class="s">"symptoms"</span><span class="o">))</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">ailments</span><span class="o">;</span> <span class="n">ailments</span> <span class="o">-&gt;</span> <span class="n">diseases</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">ailments</span><span class="o">;</span> <span class="n">ailments</span> <span class="o">-&gt;</span> <span class="n">illnesses</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">ailments</span><span class="o">;</span> <span class="n">ailments</span> <span class="o">-&gt;</span> <span class="n">genes</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">ailments</span><span class="o">;</span> <span class="n">ailments</span> <span class="o">-&gt;</span> <span class="n">chronic</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">ailments</span><span class="o">;</span> <span class="n">ailments</span> <span class="o">-&gt;</span> <span class="n">treat</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">ailments</span><span class="o">;</span> <span class="n">ailments</span> <span class="o">-&gt;</span> <span class="n">diabetes</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">ailments</span><span class="o">;</span> <span class="n">ailments</span> <span class="o">-&gt;</span> <span class="n">disorders</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">autism</span><span class="o">;</span> <span class="n">autism</span> <span class="o">-&gt;</span> <span class="n">placebos</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">brain</span><span class="o">;</span> <span class="n">brain</span> <span class="o">-&gt;</span> <span class="n">cells</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">brain</span><span class="o">;</span> <span class="n">brain</span> <span class="o">-&gt;</span> <span class="n">liver</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">chronic</span><span class="o">;</span> <span class="n">chronic</span> <span class="o">-&gt;</span> <span class="n">diabetes</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">chronic</span><span class="o">;</span> <span class="n">chronic</span> <span class="o">-&gt;</span> <span class="n">diseases</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">chronic</span><span class="o">;</span> <span class="n">chronic</span> <span class="o">-&gt;</span> <span class="n">respiratory</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">chronic</span><span class="o">;</span> <span class="n">chronic</span> <span class="o">-&gt;</span> <span class="n">disorders</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">chronic</span><span class="o">;</span> <span class="n">chronic</span> <span class="o">-&gt;</span> <span class="n">ailments</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">chronic</span><span class="o">;</span> <span class="n">chronic</span> <span class="o">-&gt;</span> <span class="n">illnesses</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">diabetes</span><span class="o">;</span> <span class="n">diabetes</span> <span class="o">-&gt;</span> <span class="n">disorders</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">diabetes</span><span class="o">;</span> <span class="n">diabetes</span> <span class="o">-&gt;</span> <span class="n">disease</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">diabetes</span><span class="o">;</span> <span class="n">diabetes</span> <span class="o">-&gt;</span> <span class="n">chronic</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">diabetes</span><span class="o">;</span> <span class="n">diabetes</span> <span class="o">-&gt;</span> <span class="n">ailments</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">diabetes</span><span class="o">;</span> <span class="n">diabetes</span> <span class="o">-&gt;</span> <span class="n">diseases</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">diabetes</span><span class="o">;</span> <span class="n">diabetes</span> <span class="o">-&gt;</span> <span class="n">respiratory</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">diabetes</span><span class="o">;</span> <span class="n">diabetes</span> <span class="o">-&gt;</span> <span class="n">illnesses</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">diabetes</span><span class="o">;</span> <span class="n">diabetes</span> <span class="o">-&gt;</span> <span class="n">alzheimer</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">diabetes</span><span class="o">;</span> <span class="n">diabetes</span> <span class="o">-&gt;</span> <span class="n">liver</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">diagnosed</span><span class="o">;</span> <span class="n">diagnosed</span> <span class="o">-&gt;</span> <span class="n">suffering</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">disorder</span><span class="o">;</span> <span class="n">disorder</span> <span class="o">-&gt;</span> <span class="n">disorders</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">disorder</span><span class="o">;</span> <span class="n">disorder</span> <span class="o">-&gt;</span> <span class="n">syndrome</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">disorders</span><span class="o">;</span> <span class="n">disorders</span> <span class="o">-&gt;</span> <span class="n">liver</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">disorders</span><span class="o">;</span> <span class="n">disorders</span> <span class="o">-&gt;</span> <span class="n">diseases</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">disorders</span><span class="o">;</span> <span class="n">disorders</span> <span class="o">-&gt;</span> <span class="n">genetic</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">disorders</span><span class="o">;</span> <span class="n">disorders</span> <span class="o">-&gt;</span> <span class="n">ailments</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">disorders</span><span class="o">;</span> <span class="n">disorders</span> <span class="o">-&gt;</span> <span class="n">chronic</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">disorders</span><span class="o">;</span> <span class="n">disorders</span> <span class="o">-&gt;</span> <span class="n">cognitive</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">disorders</span><span class="o">;</span> <span class="n">disorders</span> <span class="o">-&gt;</span> <span class="n">diabetes</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">disorders</span><span class="o">;</span> <span class="n">disorders</span> <span class="o">-&gt;</span> <span class="n">respiratory</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">disorders</span><span class="o">;</span> <span class="n">disorders</span> <span class="o">-&gt;</span> <span class="n">disorder</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">genes</span><span class="o">;</span> <span class="n">genes</span> <span class="o">-&gt;</span> <span class="n">ailments</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">illnesses</span><span class="o">;</span> <span class="n">illnesses</span> <span class="o">-&gt;</span> <span class="n">diabetes</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">illnesses</span><span class="o">;</span> <span class="n">illnesses</span> <span class="o">-&gt;</span> <span class="n">respiratory</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">illnesses</span><span class="o">;</span> <span class="n">illnesses</span> <span class="o">-&gt;</span> <span class="n">ailments</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">illnesses</span><span class="o">;</span> <span class="n">illnesses</span> <span class="o">-&gt;</span> <span class="n">diseases</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">illnesses</span><span class="o">;</span> <span class="n">illnesses</span> <span class="o">-&gt;</span> <span class="n">chronic</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">medication</span><span class="o">;</span> <span class="n">medication</span> <span class="o">-&gt;</span> <span class="n">patient</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">respiratory</span><span class="o">;</span> <span class="n">respiratory</span> <span class="o">-&gt;</span> <span class="n">disorders</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">respiratory</span><span class="o">;</span> <span class="n">respiratory</span> <span class="o">-&gt;</span> <span class="n">diabetes</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">respiratory</span><span class="o">;</span> <span class="n">respiratory</span> <span class="o">-&gt;</span> <span class="n">chronic</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">respiratory</span><span class="o">;</span> <span class="n">respiratory</span> <span class="o">-&gt;</span> <span class="n">illnesses</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">treat</span><span class="o">;</span> <span class="n">treat</span> <span class="o">-&gt;</span> <span class="n">ailments</span>
<span class="n">symptoms</span> <span class="o">-&gt;</span> <span class="n">treat</span><span class="o">;</span> <span class="n">treat</span> <span class="o">-&gt;</span> <span class="n">affects</span></code></pre></figure>



<p><h3>Topic Examples</h3>
<p>
We used a semi-manual way on building Gephi graphs: created a list of friends of a friends for top PageRank words of each topic on DOT language.
  </p><p>

Top PageRank word - 'funny':</p>
</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">display</span><span class="o">(</span><span class="n">foaf2dot</span><span class="o">(</span><span class="n">graphInsight2</span><span class="o">,</span><span class="s">"funny"</span><span class="o">))</span></code></pre></figure>


<a href="#">
    <img src="/img/graph20b.jpg" alt="Post Sample Image" width="400" />
</a>

<p>Top PageRank word - 'decrease':</p>


<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">display</span><span class="o">(</span><span class="n">foaf2dot</span><span class="o">(</span><span class="n">graphInsight2</span><span class="o">,</span><span class="s">"decrease"</span><span class="o">))</span></code></pre></figure>


<a href="#">
    <img src="/img/graph17b.jpg" alt="Post Sample Image" width="450" />
</a>

<p>Top PageRank word -  'integrated':</p>


<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">display</span><span class="o">(</span><span class="n">foaf2dot</span><span class="o">(</span><span class="n">graphInsight2</span><span class="o">,</span><span class="s">"integrated"</span><span class="o">))</span></code></pre></figure>


<a href="#">
    <img src="/img/graph15dl.jpg" alt="Post Sample Image" width="450" />
</a>

<p>Top PageRank word - 'symptoms':</p>


<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">display</span><span class="o">(</span><span class="n">foaf2dot</span><span class="o">(</span><span class="n">graphInsight2</span><span class="o">,</span><span class="s">"symptoms"</span><span class="o">))</span></code></pre></figure>


<a href="#">
    <img src="/img/graph20d.jpg" alt="Post Sample Image" width="347" />
</a>

<p>Top PageRank word - 'emory':</p>


<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">display</span><span class="o">(</span><span class="n">foaf2dot</span><span class="o">(</span><span class="n">graphInsight2</span><span class="o">,</span><span class="s">"emory"</span><span class="o">))</span></code></pre></figure>


<a href="#">
    <img src="/img/graph21.jpg" alt="Post Sample Image" width="391" />
</a>




<p><h3>Next Post - Associations and Deep Learning</h3>
<p>
In the next post we will deeper look at deep learning for data associations.</p>
</p></p></p></p>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/11/09/word2vec2graph4languageModel/" data-toggle="tooltip" data-placement="top" title="Deep Learning Language Model">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2019/05/09/Spark2knowledge/" data-toggle="tooltip" data-placement="top" title="Explainable AI Mind Mapping">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a href="mailto:sparkling.dataocean@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Melenar 2021</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-114694347-1', 'auto');
  ga('send', 'pageview');

</script>



</body>

</html>
